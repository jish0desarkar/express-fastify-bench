# üöÄ Express vs Fastify Benchmark Suite

This repository contains identical Express 5 and Fastify 5 APIs backed by Prisma and PostgreSQL plus an `autocannon` harness so you can capture reproducible latency/throughput numbers. Every request touches the database, response payloads are intentionally heavy, and the bench runner stores raw + human-readable artifacts for later analysis.

---

## Stack at a Glance

- **Runtime & tooling** ‚Äì Node.js 20+, TypeScript, `pnpm@10.18.2`, `tsx` for dev/watch and `tsc` for builds.
- **Web frameworks** ‚Äì `express@5` (`src/express`) and `fastify@5` (`src/fastify`) exposing the same routes.
- **Data layer** ‚Äì Prisma ORM with the PostgreSQL driver (`@prisma/adapter-pg`) and generated client code in `src/generated`.
- **Benchmarking** ‚Äì `autocannon` runner (`src/bench/fastify-bench.ts`) that writes `.json` + `.txt` reports into `benchmarks/`.

---

## Repository Layout

```
src/
  express/       # Express server (ports 3000)
  fastify/       # Fastify server (ports 3001, extra schema variants)
  bench/         # autocannon benchmark runner(s)
  database-connection.ts  # Prisma client wiring
  generated/     # Prisma client output (do not edit by hand)
prisma/
  schema.prisma  # User + Order models
  migrations/    # SQL migrations generated by Prisma
benchmarks/      # Benchmark artifacts (timestamped JSON + TXT)
dist/            # Compiled JS once you run `pnpm build`
src/huge-orders.json # Optional large payload for custom experiments
```

---

## API Surface

| Server   | Port | Route                         | Description                                                             |
|----------|------|-------------------------------|-------------------------------------------------------------------------|
| Express  | 3000 | `POST /create-user`           | Inserts a `users` row via Prisma and returns the created record.        |
| Express  | 3000 | `GET /mock-response`          | Returns a large synthetic JSON payload to stress serialization.        |
| Fastify  | 3001 | `POST /create-user`           | Mirrors Express endpoint with JSON schema validation.                  |
| Fastify  | 3001 | `GET /mock-response-no-schema`| Sends the same mock payload without schema validation.                 |
| Fastify  | 3001 | `GET /mock-response-with-schema` | Returns the mock payload but enforces the documented schema.        |

Use the endpoints as-is or extend both frameworks in parallel to keep the comparison fair.

---

## Requirements

1. **Node.js 20 or newer** (ESM-only project)  
2. **pnpm 10.18.2** (automatically enforced via `packageManager`)  
3. **PostgreSQL** (local Docker container or remote instance)  
4. **Environment** ‚Äì Create a `.env` file in the repo root with at least:
   ```bash
   DATABASE_URL="postgresql://user:password@localhost:5432/express_fastify_bench"
   ```

---

## Setup

```bash
pnpm install
pnpm exec prisma generate        # Emits the client into src/generated
pnpm exec prisma migrate deploy  # Applies SQL in prisma/migrations to the target DB
```

- For iterative schema work, run `pnpm exec prisma migrate dev --name <change>` instead of `deploy`.
- `prisma.config.ts` already wires the schema + migrations path and reads `DATABASE_URL` for you.

---

## Running the Servers

1. **Start Express (port 3000)**
   ```bash
   pnpm dev:express
   ```
2. **Start Fastify (port 3001)**
   ```bash
   pnpm dev:fastify
   ```

Both commands use `tsx watch`, so they live-reload on TypeScript changes. For production-style runs:

```bash
pnpm build
pnpm start:express   # or pnpm start:fastify
```

---

## Benchmarking Workflow

1. Keep the target server running (Fastify on `http://localhost:3001` by default).
2. Execute the benchmark runner:
   ```bash
   pnpm exec tsx src/bench/fastify-bench.ts
   ```
3. Results are saved inside `benchmarks/fastify/` as twin `.json` and `.txt` files (e.g. `bench_c200_d30_<timestamp>.json`).

### Customising Runs

Edit `src/bench/fastify-bench.ts`:

- `TARGET_URL` ‚Äì point to the Express server or a different endpoint.
- `CONNECTIONS` ‚Äì list of concurrent client counts (default `[200]`).
- `DURATION` ‚Äì seconds per round (default `30`).
- `WORKERS` ‚Äì number of `autocannon` worker threads (default `4`).

Each concurrency level is executed sequentially, and progress bars are rendered live via `autocannon.track`.

---

## Available Scripts

| Command | Purpose |
|---------|---------|
| `pnpm dev:express` / `pnpm dev:fastify` | Run the TS sources directly with reload. |
| `pnpm build` | Emit JavaScript into `dist/`. |
| `pnpm start:express` / `pnpm start:fastify` | Serve the built artifacts. |
| `pnpm type-check` | Run `tsc --noEmit`. |
| `pnpm exec prisma generate` | Regenerate Prisma client after schema edits. |
| `pnpm exec prisma migrate deploy` | Apply migrations in production or CI. |

---

## Database Model

`prisma/schema.prisma` defines:

- `User` ‚Äì `id` (serial PK) + `name`.  
- `Order` ‚Äì `id`, `value`, `product` (useful for crafting larger benchmarks ‚Äì see `src/huge-orders.json`).  

Prisma outputs the client into `src/generated`, and `src/database-connection.ts` wires it through the PostgreSQL adapter so both servers share the same pool.

---

## Troubleshooting

- **Connection refused / hangs:** verify Postgres is reachable via the `DATABASE_URL` used by Prisma.  
- **`prisma generate` errors:** delete `node_modules` + `pnpm install`, then rerun `pnpm exec prisma generate`.  
- **Benchmark fails instantly:** make sure the target server port matches `TARGET_URL`, and the route accepts the HTTP method used by `autocannon`.  
- **Migrations already applied:** running `pnpm exec prisma migrate deploy` is safe‚ÄîPrisma skips previously applied migrations.

---

## Extending the Benchmarks

- Add new endpoints in both `src/express` and `src/fastify` to compare middleware stacks, schema validation, or streaming responses.
- Introduce heavier DB workloads by expanding the Prisma schema (remember to run `prisma migrate dev` and regenerate the client).
- Duplicate `src/bench/fastify-bench.ts` to track multiple target URLs or integrate the suite into CI for regression tracking.

Happy benchmarking! üèéÔ∏è
